// D:\reactxx\muix\src\ks\common\muix-doc\grid-list\TitlebarGridList.tsx, wrong title

import generate from '@babel/generator';
import { parse, parseExpression } from '@babel/parser';
import * as fsExtra from 'fs-extra';
import { readAllCodes } from '../utils/readAllCodes'
import * as Ast from '../utils/ast';
import * as Config from '../utils/config';
import * as Queries from '../utils/queries';
import { cssjsToFelaLow } from './ast/cssjs-to-fela';
import { replaceAll, processMatchAll } from '../utils/regexp';

export const codeModDoc = () => {

    const { log, codeStr } = readAllCodes()

    try { fsExtra.emptyDirSync(Config.muiWeb) } catch { }

    // refresh list of all example files (save to ./doclist.ts)
    // const _ignoreAll = {}
    // Object.keys(log).forEach(k => _ignoreAll[k] = true)
    // const ignoreAllStr = JSON.stringify(_ignoreAll, null, 2)

    const exampleGroups: { [group: string]: string[] } = {}

    for (const path in log) {
        const logp = log[path]

        // ignore some examples
        if (ignores[path]) continue

        // code string modification
        let code = codeStr[path]
        code = codeModAst(code, path)
        code = codeModFile(code, path)

        // output code
        fsExtra.outputFileSync(logp.destPath + '.tsx', Config.msgAutoGenerated + code);

        // register example
        if (logp.name.charAt(0).toUpperCase() === logp.name.charAt(0))
            (exampleGroups[logp.dir] || (exampleGroups[logp.dir] = [])).push(logp.name)
    }

    // generate index.ts files
    const templateImports = []
    for (const p in exampleGroups) {
        const examples = exampleGroups[p]
        const imports = examples.map(e => `import ${e} from './${e}'`).join('\n')
        const comps = examples.map(e =>
            `<h2>${e}</h2>
<div style={{flexShrink: 0}}>
  <${e}/>
</div>
`).join('\n')
        const code =
            `
import React from 'react';

${imports}

const App: React.SFC = () => <div style={{padding: 30, overflow:'auto'}}>
  ${comps}
</div>

export default App
`
        const fn = `${Config.muiWeb}${p}/index.tsx/`
        templateImports.push(`import App from '../common/muix-doc/${p}/index'`)
        fsExtra.outputFileSync(fn, code)
    }
    const templateImport = templateImports.join('\n')
}

const codeModAst = (code: string, path: string) => {
    let root; const start = () => root = parseCodeLow(code); const end = () => generateCode(root)
    switch (path) {
        case 'buttons/ButtonBases':
            start()
            let sheet = Queries.checkSingleResult(Ast.astq().query(root, '// VariableDeclaration/VariableDeclarator [ /Identifier [@name == "styles"] ]'))
            cssjsToFelaLow(sheet, { destPath: path })
            return end()
        default:
            return code
    }
}

const parseExpressionLow = (code: string) => parseExpression(code, { plugins: ['jsx', 'objectRestSpread', 'classProperties', 'typescript'] });
const parseCodeLow = (code: string) => parse(code, { sourceType: 'module', plugins: ['jsx', 'objectRestSpread', 'classProperties', 'typescript'] });
const generateCode = (ast: Ast.Ast) => generate(ast, { /* options */ }).code as string

// const adjustHtmlClassNameAttribute = (root: Ast.Ast) => {
//     const htmls = Ast.astq().query(root, '// JSXElement') as Ast.Ast[]
//     const classNames = 'classNames('
//     htmls.forEach(html => {
//         const compName: string = html.openingElement.name.name
//         const clasName = Queries.checkSingleResult(Ast.astq().query(html, '/JSXOpeningElement/JSXAttribute [ /JSXIdentifier [ @name=="className" ] ]'), true)
//         if (!clasName) return
//         const oldCode = generateCode(clasName.value.expression)
//         const classNameProc = compName.charAt(0).toLowerCase() === compName.charAt(0) ? 'classNamesStr(' : `classNames(`
//         const newCode = oldCode.startsWith(classNames) ? classNameProc + oldCode.substr(classNames.length) : `${classNameProc}${oldCode})`
//         clasName.value.expression = parseExpressionLow(newCode)
//     })
//     return root
// }


const codeModFile = (example: string, path: string) => {
    switch (path) {
        case 'autocomplete/IntegrationDownshift':
            example = processMatchAll(/startAdornment(\s|.)*?(}\),)/g, example, (match, res) => res.push(example.substr(match.index, match[0].length - 3) + '} as any),'))
            break
        case 'buttons/CustomizedButtons':
        case 'text-fields/CustomizedInputs':
            example = example.replace(`import { withStyles, MuiThemeProvider, createMuiTheme } from '@material-ui/core/styles';`,
                `import { ThemeProvider } from 'reactxx-basic';
import createMuiTheme from 'reactxx-mui-web/styles/createMuiTheme';
import withStylesCreator from 'reactxx-mui-web/styles/withStyles'`)
            example = replaceAll(example, '<MuiThemeProvider theme={theme}>', '<ThemeProvider theme={theme as any}>')
            example = replaceAll(example, 'MuiThemeProvider', 'ThemeProvider')
            break
        case 'menus/MenuListComposition':
            example = replaceAll(example, `  handleToggle = () => {`, `  anchorEl\n  handleToggle = () => {`)
            example = replaceAll(example, 'id="menu-list-grow"', '{...{id:"menu-list-grow"}}')
            break
        case 'snackbars/ConsecutiveSnackbars':
        case 'snackbars/SimpleSnackbar':
            example = replaceAll(example, 'handleClose = (event, reason)', 'handleClose = (event, reason?)')
            break
        case 'steppers/HorizontalLinearStepper':
        case 'steppers/HorizontalNonLinearStepperWithError':
            example = replaceAll(example, 'const props = {};', 'const props: any = {};')
            example = replaceAll(example, 'const labelProps = {};', 'const labelProps: any = {};')
            break
        case 'steppers/HorizontalNonLinearAlternativeLabelStepper':
            example = replaceAll(example, 'const props = {};', 'const props: any = {};')
            example = replaceAll(example, 'const buttonProps = {};', 'const buttonProps: any = {};')
            break
        case 'tables/CustomPaginationActionsTable':
            example = replaceAll(example, '(\n  TablePaginationActions,\n);', '(TablePaginationActions);')
            break
        case 'tables/EnhancedTable':
            example = replaceAll(example, 'let EnhancedTableToolbar = ', 'let EnhancedTableToolbar: any = ')
            break
        case 'selects/MultipleSelect':
            example = replaceAll(example, 'renderValue={selected =>', 'renderValue={(selected: any) =>')
            example = processMatchAll(/style={{(\s|.)*?(}})/g, example, (match, res) => res.push(example.substr(match.index, match[0].length - 3) + '} as any}'))
            break
        case 'progress/CircularIndeterminate':
            example = replaceAll(example, '{ color: purple[500] }', '{ color: purple[500] } as any')
            break
        case 'tables/CustomizedTable':
            const endPart = '}))(TableCell);'
            example = processMatchAll(/withStyles\(theme(\s|.)*?(}\)\)\(TableCell\);)/g, example, (match, res) => res.push(example.substr(match.index, match[0].length - endPart.length) + '} as any), TableCell as any)() as typeof TableCell;'))
            example = replaceAll(example, 'const CustomTableCell = withStyles(', 'const CustomTableCell = withStylesCreator(')
            break
        case 'buttons/FloatingActionButtonZoom':
            example = example.replace('const { classes, theme } = this.props;', 'const { classes, $system: {theme} } = this.props;')
            example = example.replace('color={fab.color}', 'color={fab.color as any}')
            break
        case 'cards/MediaControlCard':
            example = example.replace('const { classes, theme } = props;', 'const { classes, $system: {theme} } = props;')
            break
        case 'chips/Chips':
            example = example.replace('href="#chip"', '{...{href:"#chip"}}')
            break
        case 'dialogs/ConfirmationDialog':
            example = example.replace('super();', 'super(props);')
            break
        case '':
            example = example.replace('', '')
            break
    }

    example = importComponents(example)
    example = importIcons(example)
    example = replaceWithStyles(example)

    example = replaceAll(example, '\n  state = {', '\n  state: any = {')
    example = replaceAll(example, `import { withStyles } from '@material-ui/core/styles';`, `import withStylesCreator from 'reactxx-mui-web/styles/withStyles'`)
    example = replaceAll(example, `.propTypes = {`, `['propTypes'] = {`)
    example = replaceAll(example, `extends React.Component {`, `extends React.Component<any,any> {`)
    example = replaceAll(example, `@material-ui/core/`, `reactxx-mui-web/`)
    example = replaceAll(example, `/static/images/`, `src/ks/common/muix/static/images/`)
    //************ CLASSNAMES
    example = example.replace(`import classNames from 'classnames';`, `import { classNames } from 'reactxx-basic';`)

    return example
}


const importComponents = (example: string) => processMatchAll(importComponentRegExp, example, (match, res) => {
    let matchStr = example.substr(match.index, match[0].length - 2)
    res.push(matchStr.replace('@material-ui/core/', 'reactxx-muix/current/'))
    res.push('/')
    res.push(match[1])
    res.push("';")
})
const importComponentRegExp = /^import ([A-Z]\w+).*@material-ui\/core\/\w+';/gm

const importIcons = (example: string) => processMatchAll(importIconRegExp, example, (match, res) => {
    res.push(example.substr(match.index, match[0].length).replace('@material-ui/icons/', 'reactxx-icons/'))
})
const importIconRegExp = /^import .*@material-ui\/icons\//gm

const replaceWithStyles = (example: string) => processMatchAll(withStylesRegExp, example, (match, res) => {
    res.push(`withStylesCreator(${match[1]} as any, ${match[3]}${match[2]})();`)
})
const withStylesRegExp = /withStyles\((\w+)(.*?)\)\((\w+)\);$/gm

const ignores = {
    'autocomplete/IntegrationAutosuggest': true,
    'autocomplete/IntegrationReactSelect': true,
    'snackbars/CustomizedSnackbars': true,
    'chips/ChipsPlayground': true,
    'dialogs/ResponsiveDialog': true,
}